name: immich

services:
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    # Keep default service name; give a stable container name so Caddy can resolve it
    container_name: immich-server
    restart: always
    depends_on:
      - redis
      - database
    # ports: # Exposed via Caddy on shared network; no host ports
    #   - "2283:2283"
    volumes:
      - ${UPLOAD_LOCATION:-./library}:/data
      - /etc/localtime:/etc/localtime:ro
    env_file:
      - ./docker-compose.env
    healthcheck:
      disable: false
    networks:
      - main-network

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    restart: always
    volumes:
      - model-cache:/cache
    env_file:
      - ./docker-compose.env
    healthcheck:
      disable: false
    networks:
      - main-network

  redis:
    image: docker.io/valkey/valkey:8@sha256:81db6d39e1bba3b3ff32bd3a1b19a6d69690f94a3954ec131277b9a26b95b3aa
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
    networks:
      - main-network

  database:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:bcf63357191b76a916ae5eb93464d65c07511da41e3bf7a8416db519b40b1c23
    restart: always
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_DB: ${DB_DATABASE_NAME:-immich}
      POSTGRES_INITDB_ARGS: '--data-checksums'
    volumes:
      - ${DB_DATA_LOCATION:-./postgres}:/var/lib/postgresql/data
    shm_size: 128mb
    networks:
      - main-network

volumes:
  model-cache:

networks:
  # Attach to the shared network created by the main stack so Caddy can reach immich-server
  main-network:
    # Use the actual network name created by the main compose project.
    # When you run the main stack from the `docker/` folder, Compose creates
    # a network named `docker_main-network` (project name `docker` + network key).
    external: true
    name: docker_main-network
